{% extends "base.html" %}

{% block title %}ä¸ {{ other_user.username }} èŠå¤© - æ ¡å›­ä¼—åˆ›å¹³å°{% endblock %}

{% block styles %}
<style>
.private-chat-container {
    max-width: 1000px;
    margin: 20px auto;
    padding: 0 15px;
    display: flex;
    flex-direction: column;
    height: calc(100vh - 150px);
}

.chat-header {
    background: #fff;
    border-radius: 10px 10px 0 0;
    padding: 15px 20px;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #f0f0f0;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 15px;
    object-fit: cover;
}

.user-info {
    flex-grow: 1;
}

.user-name {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 3px;
}

.user-status {
    font-size: 12px;
    color: #888;
}

.online-status {
    color: #4CAF50;
}

.chat-actions {
    display: flex;
    gap: 10px;
}

.action-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    color: #555;
    padding: 5px;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s;
}

.action-btn:hover {
    background-color: #f0f0f0;
    color: #4a89dc;
}

.chat-messages {
    flex-grow: 1;
    background: #fff;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.message {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 18px;
    position: relative;
    word-break: break-word;
    line-height: 1.4;
}

.message.sent {
    align-self: flex-end;
    background-color: #4a89dc;
    color: white;
    border-bottom-right-radius: 4px;
}

.message.received {
    align-self: flex-start;
    background-color: #f1f1f1;
    color: #333;
    border-bottom-left-radius: 4px;
}

.message-time {
    font-size: 10px;
    margin-top: 5px;
    opacity: 0.7;
    text-align: right;
}

.chat-date-separator {
    text-align: center;
    position: relative;
    margin: 15px 0;
}

.date-text {
    display: inline-block;
    background: white;
    padding: 0 10px;
    position: relative;
    z-index: 1;
    font-size: 12px;
    color: #888;
}

.chat-date-separator::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: 50%;
    height: 1px;
    background: #eee;
    z-index: 0;
}

.chat-input-container {
    background: #fff;
    padding: 15px;
    border-top: 1px solid #f0f0f0;
    border-radius: 0 0 10px 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.05);
}

.emoji-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    color: #555;
    padding: 5px;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background-color 0.3s;
}

.emoji-btn:hover {
    background-color: #f0f0f0;
    color: #4a89dc;
}

.message-input {
    flex-grow: 1;
    padding: 10px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 20px;
    font-size: 14px;
    resize: none;
    height: 42px;
    outline: none;
    transition: border-color 0.3s;
}

.message-input:focus {
    border-color: #4a89dc;
}

.send-button {
    background-color: #4a89dc;
    color: white;
    border: none;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.3s;
}

.send-button:hover {
    background-color: #3a70b1;
}

.send-button:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.empty-state {
    text-align: center;
    padding: 30px;
    margin: auto;
    color: #888;
}

.empty-icon {
    font-size: 40px;
    margin-bottom: 10px;
    color: #ccc;
}

/* å·²è¯»çŠ¶æ€ */
.read-status {
    font-size: 11px;
    margin-top: 2px;
    text-align: right;
    color: rgba(255, 255, 255, 0.7);
}

@media (max-width: 768px) {
    .private-chat-container {
        height: calc(100vh - 130px);
    }
}
</style>
{% endblock %}

{% block content %}
<div class="private-chat-container">
    <!-- èŠå¤©å¤´éƒ¨ -->
    <div class="chat-header">
        <img src="{{ other_user.avatar or '/static/images/default_avatar.png' }}" alt="{{ other_user.username }}" class="user-avatar">
        <div class="user-info">
            <div class="user-name">{{ other_user.username }}</div>
            <div class="user-status">
                {{ other_user.department or '' }} {{ other_user.major or '' }}
            </div>
        </div>
        <div class="chat-actions">
            <a href="{{ url_for('profile.index') }}" class="action-btn" title="è¿”å›">
                <i class="fas fa-arrow-left"></i>
            </a>
            <a href="{{ url_for('profile.messages') }}" class="action-btn" title="æ‰€æœ‰æ¶ˆæ¯">
                <i class="fas fa-comments"></i>
            </a>
            <a href="{{ url_for('user.detail', user_id=other_user.id) }}" class="action-btn" title="æŸ¥çœ‹èµ„æ–™">
                <i class="fas fa-user"></i>
            </a>
        </div>
    </div>
    
    <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
    <div class="chat-messages" id="chat-messages">
        {% if messages %}
            {% set current_date = None %}
            {% for message in messages %}
                {% set message_date = message.created_at.strftime('%Y-%m-%d') %}
                {% if current_date != message_date %}
                    <div class="chat-date-separator">
                        <span class="date-text">{{ message_date }}</span>
                    </div>
                    {% set current_date = message_date %}
                {% endif %}
                
                <div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}">
                    {{ message.content }}
                    <div class="message-time">
                        {{ message.created_at.strftime('%H:%M') }}
                        {% if message.sender_id == current_user.id %}
                            <span class="read-status">{{ 'å·²è¯»' if message.is_read else 'æœªè¯»' }}</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="fas fa-comment-dots"></i></div>
                <p>è¿˜æ²¡æœ‰æ¶ˆæ¯è®°å½•ï¼Œå‘é€ä¸€æ¡æ¶ˆæ¯å¼€å§‹èŠå¤©å§ï¼</p>
            </div>
        {% endif %}
    </div>
    
    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="chat-input-container">
        <button class="emoji-btn" title="è¡¨æƒ…" id="emoji-btn">
            <i class="far fa-smile"></i>
        </button>
        <textarea id="message-input" class="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
        <button id="send-button" class="send-button" disabled>
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatMessages = document.getElementById('chat-messages');
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // åˆå§‹åŒ–æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom();
    
    // å¯ç”¨/ç¦ç”¨å‘é€æŒ‰é’®
    messageInput.addEventListener('input', function() {
        sendButton.disabled = this.value.trim() === '';
        
        // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŒºåŸŸé«˜åº¦
        this.style.height = 'auto';
        const newHeight = Math.min(this.scrollHeight, 120);
        if (newHeight > 42) {
            this.style.height = newHeight + 'px';
        } else {
            this.style.height = '42px';
        }
    });
    
    // å›è½¦é”®å‘é€æ¶ˆæ¯
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!sendButton.disabled) {
                sendMessage();
            }
        }
    });
    
    // å‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    sendButton.addEventListener('click', sendMessage);
    
    // å‘é€æ¶ˆæ¯å‡½æ•°
    function sendMessage() {
        const content = messageInput.value.trim();
        if (!content) return;
        
        // å‘é€æ¶ˆæ¯ AJAX è¯·æ±‚
        fetch('{{ url_for("profile.send_message", user_id=other_user.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: `content=${encodeURIComponent(content)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
                addMessageToChat(data.message_data);
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                messageInput.value = '';
                messageInput.style.height = '42px';
                sendButton.disabled = true;
                
                // æ»šåŠ¨åˆ°åº•éƒ¨
                scrollToBottom();
            } else {
                alert('å‘é€å¤±è´¥ï¼š' + data.message);
            }
        })
        .catch(error => {
            console.error('å‘é€æ¶ˆæ¯å‡ºé”™:', error);
            alert('å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
        });
    }
    
    // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
    function addMessageToChat(messageData) {
        // æ£€æŸ¥æ—¥æœŸåˆ†éš”çº¿
        const today = new Date().toISOString().slice(0, 10);
        const lastDateSeparator = chatMessages.querySelector('.chat-date-separator:last-child .date-text');
        
        // å¦‚æœæ—¥æœŸä¸æœ€åä¸€ä¸ªåˆ†éš”ç¬¦ä¸åŒï¼Œæ·»åŠ æ–°çš„æ—¥æœŸåˆ†éš”ç¬¦
        if (!lastDateSeparator || lastDateSeparator.textContent !== today) {
            const dateSeparator = document.createElement('div');
            dateSeparator.className = 'chat-date-separator';
            dateSeparator.innerHTML = `<span class="date-text">${today}</span>`;
            chatMessages.appendChild(dateSeparator);
        }
        
        // åˆ›å»ºæ¶ˆæ¯å…ƒç´ 
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message sent';
        
        const messageTime = new Date(messageData.created_at || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageDiv.innerHTML = `
            ${messageData.content}
            <div class="message-time">
                ${messageTime}
                <span class="read-status">æœªè¯»</span>
            </div>
        `;
        
        chatMessages.appendChild(messageDiv);
    }
    
    // è‡ªåŠ¨åˆ·æ–°èŠå¤©å†…å®¹ï¼ˆæ¯5ç§’ï¼‰
    function refreshChat() {
        // å®é™…é¡¹ç›®ä¸­å¯ä»¥ä½¿ç”¨ WebSocket æˆ– é•¿è½®è¯¢ å®ç°å®æ—¶èŠå¤©
        // è¿™é‡Œä½¿ç”¨ç®€å•çš„å®šæ—¶åˆ·æ–°ä½œä¸ºç¤ºä¾‹
        setTimeout(refreshChat, 5000);
    }
    
    // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
    refreshChat();
    
    // ç®€å•çš„è¡¨æƒ…æŒ‰é’®åŠŸèƒ½
    const emojiBtn = document.getElementById('emoji-btn');
    emojiBtn.addEventListener('click', function() {
        // è¿™é‡Œä»…ä½œä¸ºç¤ºä¾‹ï¼Œå®é™…å¯ä»¥é›†æˆEmojié€‰æ‹©å™¨
        const emojis = ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ‘', 'â¤ï¸', 'ğŸ˜', 'ğŸ‰', 'ğŸ¤”', 'ğŸ˜'];
        const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
        
        messageInput.value += randomEmoji;
        messageInput.focus();
        sendButton.disabled = false;
    });
});
</script>
{% endblock %} 